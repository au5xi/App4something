generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum FriendshipStatus {
  PENDING
  ACCEPTED
}

enum UpStatusMode {
  OFF
  GENERAL
  SPECIFIC
}

enum ParticipantStatus {
  INVITED
  INTERESTED
  JOINED
  DECLINED
}

enum ParticipantRole {
  HOST
  COHOST
  GUEST
}

model User {
  id           String @id @default(cuid())
  name         String
  email        String @unique
  passwordHash String

  bio       String? @db.VarChar(280)
  avatarUrl String? @db.VarChar(512)

  homeLocation      String? @db.VarChar(80)
  customLocation    String? @db.VarChar(80)
  useCustomLocation Boolean @default(false)

  createdAt DateTime @default(now())

  status       UserStatus?
  availability UserAvailability[]

  hostedEvents Event[]            @relation("HostedEvents")
  cohostLinks  EventCohost[]
  participants EventParticipant[]
  shouts       ShoutMessage[]

  friendshipsA Friendship[] @relation("FriendshipA")
  friendshipsB Friendship[] @relation("FriendshipB")
}

model UserStatus {
  id        String       @id @default(cuid())
  userId    String       @unique
  mode      UpStatusMode @default(OFF)
  text      String?      @db.VarChar(64)
  updatedAt DateTime     @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserAvailability {
  id        String   @id @default(cuid())
  userId    String
  date      DateTime // date at 00:00Z (day bucket)
  isUp      Boolean  @default(false)
  upText    String?  @db.VarChar(64)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([date])
}

model Friendship {
  id        String           @id @default(cuid())
  userAId   String
  userBId   String
  status    FriendshipStatus @default(PENDING)
  createdAt DateTime         @default(now())

  userA User @relation("FriendshipA", fields: [userAId], references: [id], onDelete: Cascade)
  userB User @relation("FriendshipB", fields: [userBId], references: [id], onDelete: Cascade)

  @@unique([userAId, userBId])
}

model Event {
  id       String  @id @default(cuid())
  hostId   String
  activity String  @db.VarChar(64)
  imageUrl String? @db.VarChar(512)
  location String? @db.VarChar(80)
  notes    String? @db.VarChar(500)

  startTime   DateTime
  isInstant   Boolean  @default(false)
  isPotential Boolean  @default(false)

  createdAt DateTime @default(now())

  host         User               @relation("HostedEvents", fields: [hostId], references: [id], onDelete: Cascade)
  cohosts      EventCohost[]
  participants EventParticipant[]
  shouts       ShoutMessage[]

  @@index([startTime])
}

model EventCohost {
  id      String @id @default(cuid())
  eventId String
  userId  String

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
}

model EventParticipant {
  id        String            @id @default(cuid())
  eventId   String
  userId    String
  role      ParticipantRole   @default(GUEST)
  status    ParticipantStatus @default(INVITED)
  createdAt DateTime          @default(now())

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([userId])
}

model ShoutMessage {
  id        String   @id @default(cuid())
  eventId   String
  userId    String
  message   String   @db.VarChar(500)
  createdAt DateTime @default(now())

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([eventId, createdAt])
}
